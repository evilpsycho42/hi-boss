# Agents

This document specifies the agent model (registration, provider homes, instruction generation, execution, bindings, auditing).

See also:
- `docs/spec/cli/agents.md` (CLI commands and flags)
- `docs/spec/ipc.md` (RPC method list)
- `docs/spec/components/session.md` (session lifecycle and refresh policy)
- `docs/spec/definitions.md` (field mappings: TypeScript ↔ SQLite ↔ CLI keys)
- `docs/spec/components/routing.md` (how envelopes flow through agents)

## Overview

An agent is a named principal that can authenticate to the daemon via a token and process envelopes addressed to `agent:<name>`.

## Identity

### Name

Agent names must match `^[A-Za-z0-9]+(?:-[A-Za-z0-9]+)*$`:
- alphanumeric characters
- hyphens allowed (not at start/end; not consecutive)
- uniqueness is checked case-insensitively

### Token

Agent tokens are generated by `src/agent/auth.ts`:
- 6 random hex characters (`crypto.randomBytes(3).toString("hex")`)
- printed once by `hiboss setup` and `hiboss agent register` (no “show token” command)
- stored as plaintext in `~/.hiboss/hiboss.db` (`agents.token`)

## Authorization

The daemon authorizes token-authenticated operations using `config.permission_policy`.

- Each agent has a `permissionLevel`: `restricted`, `standard`, or `privileged`.
- Boss operations require the boss token (see `docs/spec/configuration.md`).

See `docs/spec/configuration.md#permission-policy`.

## Providers

Hi-Boss supports two agent SDK providers:

| Provider | SDK Package | Home Directory |
|----------|-------------|----------------|
| claude | `@anthropic-ai/claude-agent-sdk` | `~/.hiboss/agents/<name>/claude_home/` |
| codex | `@openai/codex-sdk` | `~/.hiboss/agents/<name>/codex_home/` |

### Provider Configuration

Set at registration or via agent settings:

| Setting | Description | Values |
|---------|-------------|--------|
| `provider` | SDK provider | `claude`, `codex` |
| `model` | Model override | Provider-specific model ID (`null`/unset means “use provider default”) |
| `reasoningEffort` | Reasoning effort override | `none`, `low`, `medium`, `high`, `xhigh` (`null`/unset means “use provider default”) |
| `autoLevel` | Automation/access level | `medium`, `high` |
| `permissionLevel` | Authorization for CLI/RPC ops | `restricted`, `standard`, `privileged` |
| `sessionPolicy` | Session refresh policy | See [Session Policy](#session-policy) |

### Access Level Mapping

The `autoLevel` setting maps to SDK access permissions:

| autoLevel | Behavior |
|-----------|----------|
| `medium` | Workspace-scoped automation: can write files in the workspace (including configured additional dirs) and run a broad set of commands, but stays workspace-scoped |
| `high` | Full-computer automation: can run almost anything on this machine (recommended only when you trust the agent) |

Note: unified-agent-sdk supports `autoLevel=low`, but Hi-Boss disallows it because Hi-Boss agent instructions rely on running the `hiboss` CLI (local IPC via `~/.hiboss/daemon.sock`), and `low` can block that. `autoLevel=medium` is the lowest supported setting that still allows agents to use the Hi-Boss envelope system.

### Real-provider behavior test

To validate that agents can actually use the Hi-Boss envelope system end-to-end (including `hiboss envelope send`) under **real** provider calls:

1) Stop the daemon and delete `~/.hiboss`
2) Run `hiboss setup default` using a known-good template (see `scripts/test-auto-level/`)
3) Start the daemon with `--debug`
4) Send a boss-marked envelope that instructs a `high` and a `medium` agent to send to a non-existent sink address (e.g., `agent:test-sink`)
5) Verify the sink inbox contains the expected `pong` messages via `hiboss envelope list --address ...`

This test incurs real provider usage (cost). See `scripts/test-auto-level/README.md` for the exact repeatable command sequence.

## Home Directories

Each agent has provider-specific home directories for configuration and state.

### Structure

```
~/.hiboss/agents/<agent-name>/
├── SOUL.md              # Optional per-agent persona (injected; truncated)
├── internal_space/      # Agent's private space, automatically added into additional directories
│   └── Note.md          # Agent notebook (injected into system prompt; truncated)
├── codex_home/
│   ├── config.toml      # Imported from provider source home (default: ~/.codex/config.toml)
│   ├── auth.json        # Imported from provider source home (default: ~/.codex/auth.json)
│   └── AGENTS.md        # Generated system instructions
└── claude_home/
    ├── settings.json    # Imported from provider source home (default: ~/.claude/settings.json)
    ├── .claude.json     # Imported from provider source home (default: ~/.claude/.claude.json)
    └── CLAUDE.md        # Generated system instructions
```

### Setup Functions

Located in `src/agent/home-setup.ts`:

| Function | Purpose |
|----------|---------|
| `setupAgentHome(agentName, opts?)` | Creates home directories and imports provider configs (provider-specific) |
| `getAgentHomePath(agentName, provider)` | Returns provider-specific home path |
| `getAgentInternalSpaceDir(agentName)` | Returns `~/.hiboss/agents/<name>/internal_space/` |
| `agentHomeExists(agentName)` | Checks if home directories exist |
| `removeAgentHome(agentName)` | Deletes agent home directory |

## Instruction Generation

System instructions define the agent's behavior and context. Instruction files are regenerated each time a new session is created (see [Session Management](session.md#creation)).

On each new session, Hi-Boss injects:
- a truncated snapshot of the agent notebook (`internal_space/Note.md`)
- optional customization files:
  - `~/.hiboss/BOSS.md` (global boss profile)
  - `~/.hiboss/agents/<agent-name>/SOUL.md` (agent persona)

### Files

- Claude: `~/.hiboss/agents/<name>/claude_home/CLAUDE.md`
- Codex: `~/.hiboss/agents/<name>/codex_home/AGENTS.md`

### Template System

Located in:
- `src/shared/prompt-renderer.ts` (Nunjucks renderer)
- `src/shared/prompt-context.ts` (context builders)
- `src/agent/instruction-generator.ts` (system instructions generation)

- Template language: **Nunjucks** (Jinja-like)
- System entrypoint: `prompts/system/base.md`
- Context variables: see `prompts/VARIABLES.md`

### Functions

| Function | Purpose |
|----------|---------|
| `generateSystemInstructions(ctx)` | Renders template with agent context |
| `writeInstructionFiles(agentName, instructions)` | Writes to both AGENTS.md and CLAUDE.md |
| `readInstructionFile(agentName, provider)` | Reads existing instruction file |

## Agent Execution

### Execution Flow

Located in `src/agent/executor.ts`:

1. **Trigger**: New envelope arrives, a scheduled envelope becomes due, or the daemon starts with pending work
2. **Lock**: Per-agent queue lock acquired (no concurrent runs for same agent)
3. **Session**: Get or create session (see [Session Management](session.md))
4. **Turn Input**: Format pending envelopes into turn input
5. **Execute**: Run agent SDK session with turn input
6. **Auto-Ack**: Mark all envelopes in the run as `done` after a successful run
7. **Audit**: Record run in `agent_runs` table
8. **Reschedule**: If more pending envelopes exist, schedule another turn via `setImmediate`

### Constants

| Constant | Value | Description |
|----------|-------|-------------|
| `MAX_ENVELOPES_PER_TURN` | 10 | Maximum envelopes processed per turn |

### Turn Input Format

Located in `src/agent/turn-input.ts`:

```
## Turn Context

now: 2026-01-28T20:30:00+08:00

---
## Pending Envelopes (2)

### Envelope 1

from: channel:telegram:12345
from-name: group "hiboss-test"

Alice (@alice) at 2026-01-28T10:25:00+08:00:
Hello, can you help me?

---

### Envelope 2
...
```

Note: consecutive group-chat envelopes from the same `from:` address are batched under a single `### Envelope <index>` header (header printed once, multiple message lines).

### Auto-Acknowledgment

After a successful agent run, Hi-Boss marks all envelopes included in that run as `done`.

If a run fails, those envelopes remain `pending` and will be retried on the next trigger (new envelope, scheduler tick, or daemon restart recovery).

## Agent Bindings

Bindings connect agents to adapters (e.g., Telegram bots).

### Database Schema

Table: `agent_bindings`

| Column | Type | Notes |
|--------|------|-------|
| id | TEXT | Primary key |
| agent_name | TEXT | Foreign key to agents |
| adapter_type | TEXT | e.g., "telegram" |
| adapter_token | TEXT | Adapter authentication |
| created_at | TEXT | ISO 8601 |

Constraints:
- Unique on `(adapter_type, adapter_token)` - each adapter binds to one agent
- Each agent can have at most one binding per adapter type

### CLI Commands
See `docs/spec/cli/agents.md` (`hiboss agent set`) for binding flags.

### Permissions

- Agents can only send to adapters they're bound to
- Sending to `channel:telegram:...` requires a telegram binding

## Session Policy

Session policies control when agent sessions are refreshed. They are stored on the agent record (`Agent.sessionPolicy` / `agents.session_policy`).

For evaluation details, see [Session Management](session.md#session-policy-evaluation). For CLI flags, see `docs/spec/cli/agents.md`.

## Agent Runs (Auditing)

All agent executions are recorded in the `agent_runs` table.

### Schema

| Column | Type | Description |
|--------|------|-------------|
| id | TEXT | Primary key |
| agent_name | TEXT | Agent that ran |
| started_at | INTEGER | Unix timestamp (ms) |
| completed_at | INTEGER | Unix timestamp (ms) |
| envelope_ids | TEXT | JSON array of processed envelope IDs |
| final_response | TEXT | Full agent response text |
| status | TEXT | `running`, `completed`, `failed` |
| error | TEXT | Error message if failed |

### Querying Runs

```bash
sqlite3 ~/.hiboss/hiboss.db \
  "SELECT id, agent_name, status, datetime(started_at/1000,'unixepoch')
   FROM agent_runs ORDER BY started_at DESC LIMIT 20;"
```

## Key Files

| Component | File |
|-----------|------|
| Types | `src/agent/types.ts` |
| Executor | `src/agent/executor.ts` |
| Home setup | `src/agent/home-setup.ts` |
| Instructions | `src/agent/instruction-generator.ts` |
| Turn input | `src/agent/turn-input.ts` |
| Auth/tokens | `src/agent/auth.ts` |
| CLI commands | `src/cli/commands/agent.ts` |
| Database schema | `src/daemon/db/schema.ts` |
| Validation | `src/shared/validation.ts` |

For session-related files, see [Session Management](session.md#key-files).
