# Agents

This document specifies the agent model (registration, provider homes, instruction generation, execution, bindings, auditing).

See also:
- `docs/spec/cli/agents.md` (CLI commands and flags)
- `docs/spec/ipc.md` (RPC method list)
- `docs/spec/components/session.md` (session lifecycle and refresh policy)
- `docs/spec/definitions.md` (field mappings: TypeScript ↔ SQLite ↔ CLI keys)
- `docs/spec/components/routing.md` (how envelopes flow through agents)

## Overview

An agent is a named principal that can authenticate to the daemon via a token and process envelopes addressed to `agent:<name>`.

## Identity

### Name

Agent names must match `^[A-Za-z0-9]+(?:-[A-Za-z0-9]+)*$`:
- alphanumeric characters
- hyphens allowed (not at start/end; not consecutive)
- uniqueness is checked case-insensitively
- reserved name: `background` (used for `agent:background`; not user-registrable)

### Token

Agent tokens are generated by `src/agent/auth.ts`:
- 6 random hex characters (`crypto.randomBytes(3).toString("hex")`)
- printed once by `hiboss setup` and `hiboss agent register` (no “show token” command)
- stored as plaintext in `~/hiboss/.daemon/hiboss.db` (`agents.token`)

## Authorization

The daemon authorizes token-authenticated operations using `config.permission_policy`.

- Each agent has a `permissionLevel`: `restricted`, `standard`, `privileged`, or `boss`.
- Boss operations require a token whose effective permission level is `boss` (boss token or a boss-level agent token).
- `permissionLevel: boss` grants authorization only; it does not mark messages as boss (`fromBoss` / `[boss]` are adapter identity, not permission).

See:
- `src/shared/defaults.ts` (`DEFAULT_PERMISSION_POLICY`)
- `docs/spec/config/sqlite.md` (`config.permission_policy`)

## Providers

Hi-Boss supports two provider CLIs:

| Provider | CLI Command | Default Home |
|----------|-------------|--------------|
| claude | `claude` (Claude Code CLI) | `~/.claude` (shared) |
| codex | `codex` (Codex CLI) | `~/.codex` (shared) |

Provider-home behavior (shared defaults, no per-agent provider homes, and cleared override env vars) is canonical in `docs/spec/provider-clis.md`. System prompts are injected via CLI flags:
- Claude: `--append-system-prompt`
- Codex: `-c developer_instructions=...`

### Provider Configuration

Set at registration or via agent settings:

| Setting | Description | Values |
|---------|-------------|--------|
| `provider` | SDK provider | `claude`, `codex` |
| `model` | Model override | Provider-specific model ID (`null`/unset means “use provider default”) |
| `reasoningEffort` | Reasoning effort override | `none`, `low`, `medium`, `high`, `xhigh` (`null`/unset means “use provider default”) |
| `permissionLevel` | Authorization for CLI/RPC ops | `restricted`, `standard`, `privileged`, `boss` |
| `sessionPolicy` | Session refresh policy | See [Session Policy](#session-policy) |

### Provider Execution Mode (Current)

Hi-Boss currently runs provider CLIs in **full-access mode** (bypassing sandboxing / permission prompts) so agents can reliably execute `hiboss` commands.

- Codex: `--dangerously-bypass-approvals-and-sandbox` (fresh + resume)
- Claude: `--permission-mode bypassPermissions`

Important: Claude Code CLI does not provide a Codex-style workspace-only filesystem sandbox. If you allow `Write`/`Edit`, assume the agent can write outside the intended workspace unless the `claude` process is externally sandboxed (container/VM/OS policy).

### Real-provider verification (dev)

To validate provider behavior under real API calls (costs money), use the scripted verifier:
- `npm run verify:token-usage:real`

Policy:
- Use a dedicated temporary `HIBOSS_DIR` (do not touch default `~/hiboss`).
- Verify both providers in both fresh and continuous session modes (see repo AGENTS instructions).

## Home Directories

Each agent has a home directory for persona and memory files.

### Structure

```
~/hiboss/agents/<agent-name>/
├── SOUL.md              # Persona placeholder (created empty; not rendered in minimal system prompt)
└── internal_space/      # Agent's private space
    └── MEMORY.md        # Agent long-term memory (auto-injected into system prompt; truncated)
    └── memories/        # Per-agent daily memory files (YYYY-MM-DD.md; not always injected)
```

### Setup Functions

Located in `src/agent/home-setup.ts`:

| Function | Purpose |
|----------|---------|
| `setupAgentHome(agentName, hibossDir?)` | Creates home directory with `internal_space/` and `SOUL.md` |
| `getAgentDir(agentName, hibossDir?)` | Returns agent directory path |
| `getAgentInternalSpaceDir(agentName)` | Returns `~/hiboss/agents/<name>/internal_space/` |
| `agentHomeExists(agentName)` | Checks if home directory exists |
| `removeAgentHome(agentName)` | Deletes agent home directory |

## Instruction Generation

System instructions define the agent's behavior and context. Instructions are regenerated as a string each time a new session is created and passed inline to the CLI:
- Claude: via `--append-system-prompt`
- Codex: via `-c developer_instructions=...`

On each new session, Hi-Boss injects:
- a truncated snapshot of the agent long-term memory file (`internal_space/MEMORY.md`)
- optionally, a truncated snapshot of recent daily memory files (`internal_space/memories/`; see `docs/spec/components/file-memory.md`)
It intentionally does not inject additional persona/profile files (the system prompt is designed to be minimal).

### Template System

Located in:
- `src/shared/prompt-renderer.ts` (Nunjucks renderer)
- `src/shared/prompt-context.ts` (context builders)
- `src/agent/instruction-generator.ts` (system instructions generation)

- Template language: **Nunjucks** (Jinja-like)
- System entrypoint: `prompts/system/base.md`
- Context variables: see `prompts/VARIABLES.md`

### Functions

| Function | Purpose |
|----------|---------|
| `generateSystemInstructions(ctx)` | Renders template with agent context; returns inline string |

## Agent Execution

### Execution Flow

Located in `src/agent/executor.ts`:

1. **Trigger**: New envelope arrives, a scheduled envelope becomes due, or the daemon starts with pending work
2. **Lock**: Per-agent queue lock acquired (no concurrent runs for same agent)
3. **Session**: Get or create session (see [Session Management](session.md))
4. **Turn Input**: Format pending envelopes into turn input
5. **Execute**: Spawn provider CLI with turn input and system instructions
6. **Auto-Ack**: Mark read envelopes as `done` immediately after they are loaded for a run (at-most-once)
7. **Audit**: Record run in `agent_runs` table
8. **Reschedule**: If more pending envelopes exist, schedule another turn via `setImmediate`

Note: Applying a declarative setup config (`hiboss setup --config-file ...`) clears `agent_runs` as part of rebuilding setup-managed state.

### Constants

| Constant | Value | Description |
|----------|-------|-------------|
| `MAX_ENVELOPES_PER_TURN` | 10 | Maximum envelopes processed per turn |

### Turn Input Format

Located in `src/agent/turn-input.ts`:

```
## Turn Context

now: 2026-01-28T20:30:00+08:00
pending-envelopes: 2

---

envelope-id: 4b7c2d1a
from: channel:telegram:12345
sender: Alice (@alice) in group "hiboss-test"
created-at: 2026-01-28T10:25:00+08:00

Hello, can you help me?

---
...
```

Note: each pending envelope is rendered one-by-one (no batching).

### Auto-Acknowledgment

Hi-Boss marks envelopes as `done` immediately after they are read for a run.

This is **at-most-once**: if a run fails, already-read envelopes stay `done` and will not be retried.

---

## Background Agent (one-shot, daemon-executed)

Hi-Boss supports a reserved one-shot destination:

- `to: agent:background`

This is used for lightweight “fire-and-forget” subtasks without granting the sub-agent access to the Hi-Boss CLI or system prompt.

Behavior (canonical):
- **Execution**: the daemon spawns a single provider CLI process (Claude Code / Codex CLI) with the envelope text + attachment list as the prompt.
- **Result extraction**: background jobs capture final assistant text via provider-native stable outputs:
  - Claude: `--output-format text` (stdout)
  - Codex: `-o/--output-last-message <file>` (read by daemon)
- **Concurrency**: background jobs are executed with a default max concurrency of `4` (implementation clamps to `1..32`).
- **No Hi-Boss system instructions**: background jobs do not receive the Hi-Boss role/system prompt injection.
- **No Hi-Boss token**: the daemon does not set `HIBOSS_TOKEN` in the background process environment.
- **Runtime permissions**: runs in the same non-interactive full-access mode as normal agent turns:
  - Codex: `--dangerously-bypass-approvals-and-sandbox`
  - Claude: `--permission-mode bypassPermissions`
- **Config inheritance**: provider/model/reasoning-effort/workspace default to the **sender agent’s** settings. If sender workspace is unset, effective workspace falls back to the user's home directory.
- **Feedback (best-effort)**: for valid sender agents, the daemon sends a feedback envelope back to the sender:
  - `from: agent:background`
  - `to: agent:<sender>`
  - `metadata.replyToEnvelopeId: <background-request-envelope-uuid>`
- **Failure feedback text**: provider/spawn/runtime failures are returned as `Background job failed: <error>` in the feedback envelope body.
- **No-feedback edge cases**: if `from` is not an agent address or the sender agent cannot be resolved, the daemon logs and drops the background request without sending feedback.
- **No conversation**: background jobs are one-shot and have no memory. Treat the feedback envelope as a result; do not send an acknowledgement reply. For follow-up work, send a new envelope to `agent:background` with full context (and a `replyToEnvelopeId` link).
- **At-most-once**: the background request envelope is ACKed immediately (marked `done`) when accepted for execution.

## Agent Bindings

Bindings connect agents to adapters (e.g., Telegram bots).

### Database Schema

Table: `agent_bindings`

| Column | Type | Notes |
|--------|------|-------|
| id | TEXT | Primary key |
| agent_name | TEXT | Foreign key to agents |
| adapter_type | TEXT | e.g., "telegram" |
| adapter_token | TEXT | Adapter authentication |
| created_at | INTEGER | Unix epoch ms (UTC) |

Constraints:
- Unique on `(adapter_type, adapter_token)` - each adapter binds to one agent
- Each agent can have at most one binding per adapter type

### CLI Commands
See `docs/spec/cli/agents.md` (`hiboss agent set`) for binding flags.

### Permissions

- Agents can only send to adapters they're bound to
- Sending to `channel:telegram:...` requires a telegram binding

## Session Policy

Session policies control when agent sessions are refreshed. They are stored on the agent record (`Agent.sessionPolicy` / `agents.session_policy`).

For evaluation details, see [Session Management](session.md#session-policy-evaluation). For CLI flags, see `docs/spec/cli/agents.md`.

## Agent Runs (Auditing)

All agent executions are recorded in the `agent_runs` table.

Note: `hiboss setup --config-file` (apply) clears `agent_runs`, so this audit trail is not preserved across declarative setup re-imports.

### Schema

| Column | Type | Description |
|--------|------|-------------|
| id | TEXT | Primary key |
| agent_name | TEXT | Agent that ran |
| started_at | INTEGER | Unix timestamp (ms) |
| completed_at | INTEGER | Unix timestamp (ms) |
| envelope_ids | TEXT | JSON array of processed envelope IDs |
| final_response | TEXT | Full agent response text |
| context_length | INTEGER | Context length (tokens) for the run when available |
| status | TEXT | `running`, `completed`, `failed`, `cancelled` |
| error | TEXT | Error message when `failed` or `cancelled` |

### Cancellation

An agent run can be cancelled by the boss (for example via Telegram `/abort` or `hiboss agent abort`).

Semantics:
- A cancelled run is terminal and is recorded as `status = cancelled`.
- Already-read envelopes remain `done` (at-most-once); cancelled runs do not retry.

### Querying Runs

```bash
sqlite3 ~/hiboss/.daemon/hiboss.db \
  "SELECT id, agent_name, status, datetime(started_at/1000,'unixepoch')
   FROM agent_runs ORDER BY started_at DESC LIMIT 20;"
```

## Key Files

| Component | File |
|-----------|------|
| Types | `src/agent/types.ts` |
| Executor | `src/agent/executor.ts` |
| Home setup | `src/agent/home-setup.ts` |
| Instructions | `src/agent/instruction-generator.ts` |
| Turn input | `src/agent/turn-input.ts` |
| Auth/tokens | `src/agent/auth.ts` |
| CLI commands | `src/cli/commands/agent.ts` |
| Database schema | `src/daemon/db/schema.ts` |
| Validation | `src/shared/validation.ts` |

For session-related files, see [Session Management](session.md#key-files).
